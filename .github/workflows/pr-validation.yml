name: PR Validation

on:
  pull_request:
    branches:
      - master
      - main

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4.1'
          bundler-cache: true  # Automatically runs 'bundle install' and caches gems

      - name: Install dependencies
        run: bundle install --jobs 4 --retry 3

      - name: Create sample config files
        run: |
          cp .hwm_credentials.sample.yml .hwm_credentials.yml
          cp secrets.sample.yml secrets.yml

      - name: Run RSpec tests
        run: bundle exec rake spec
        continue-on-error: false

      - name: Build Docker image
        run: docker build -t hwm_worker:test .

      - name: Verify Docker image
        run: |
          echo "Docker image built successfully"
          docker images | grep hwm_worker

  docker-compose-validation:
    name: Docker Compose Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Create sample config files
        run: |
          cp .hwm_credentials.sample.yml .hwm_credentials.yml
          cp secrets.sample.yml secrets.yml

      - name: Validate docker-compose configuration
        run: docker compose config

      - name: Test docker-compose build
        run: docker compose build worker hunter

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4.1'
          bundler-cache: true

      - name: Install bundler-audit
        run: gem install bundler-audit

      - name: Update vulnerability database
        run: bundle audit --update

      - name: Run security audit
        run: bundle audit check
        continue-on-error: true  # Don't fail the build, but show warnings
