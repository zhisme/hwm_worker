name: PR Validation

on:
  pull_request:
    branches:
      - master
      - main

jobs:
  build-image:
    name: Build and Verify Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create sample config files
        run: |
          cp .hwm_credentials.sample.yml .hwm_credentials.yml
          cp secrets.sample.yml secrets.yml

      - name: Build Docker image
        run: docker build -t hwm_worker:test .

      - name: Verify Docker image
        run: |
          echo "Docker image built successfully"
          docker images | grep hwm_worker

      - name: Save Docker image
        run: docker save hwm_worker:test -o /tmp/hwm_worker_image.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: hwm_worker_image
          path: /tmp/hwm_worker_image.tar
          retention-days: 1

  test:
    name: Run Tests in Docker
    runs-on: ubuntu-latest
    needs: build-image

    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: hwm_worker_image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/hwm_worker_image.tar

      - name: Run RSpec tests in Docker
        run: docker run --rm hwm_worker:test bundle exec rake spec

  docker-compose-validation:
    name: Docker Compose Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create sample config files
        run: |
          cp .hwm_credentials.sample.yml .hwm_credentials.yml
          cp secrets.sample.yml secrets.yml

      - name: Validate docker-compose configuration
        run: docker compose config

      - name: Test docker-compose build
        run: docker compose build worker hunter

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4.1'
          bundler-cache: true

      - name: Install bundler-audit
        run: gem install bundler-audit

      - name: Update vulnerability database
        run: bundle audit --update

      - name: Run security audit
        run: bundle audit check
        continue-on-error: true  # Don't fail the build, but show warnings
